version: "3.7"
services:
  vetsoft-api:
    image: mcr.microsoft.com/playwright:v1.51.1-jammy-node
    entrypoint: ["/bin/bash", "-c"]
    command: [
      "git clone https://github.com/jeanjonathas/webscraping.git /app && \
       cd /app/vetsoft && \
       npm install --no-fund --no-audit --legacy-peer-deps && \
       npm install --save-dev typescript @types/react @types/react-dom && \
       npx tsc && \
       NODE_ENV=production npm run start"
    ]
    environment:
      - VETSOFT_USERNAME=jeanvet
      - VETSOFT_PASSWORD=Je@nfree16
      - SERVER_PORT=3000
      - SUPABASE_URL=https://supabase.supervet.app
      - SUPABASE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.ewogICJyb2xlIjogInNlcnZpY2Vfcm9sZSIsCiAgImlzcyI6ICJzdXBhYmFzZSIsCiAgImlhdCI6IDE3MTUwNTA4MDAsCiAgImV4cCI6IDE4NzI4MTcyMDAKfQ.BepdiHaXIckUPHlX_SZyyCX5iizCKAxfmThdZME5YKc
      - NODE_ENV=production
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
      - DISPLAY=:99
    volumes:
      - vetsoft_data:/app
    networks:
      - vetsoft_network
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      labels:
        - traefik.enable=true
        - traefik.http.routers.vetsoft-api.rule=Host(`apivetsoft.supervet.app`)
        - traefik.http.routers.vetsoft-api.entrypoints=websecure
        - traefik.http.routers.vetsoft-api.tls=true
        - traefik.http.routers.vetsoft-api.tls.certresolver=letsencryptresolver
        - traefik.http.services.vetsoft-api.loadbalancer.server.port=3000
        - traefik.http.services.vetsoft-api.loadbalancer.passHostHeader=true
        - traefik.http.routers.vetsoft-api.service=vetsoft-api
      resources:
        limits:
          cpus: "1"
          memory: 2048M

volumes:
  vetsoft_data:
    name: vetsoft_data

networks:
  vetsoft_network:
    external: true
    name: ralliugaNet
